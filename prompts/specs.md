# ТЗ v1 — Формальные требования (FR/NFR) и критерии приемки

## 1. Область и границы системы
**Система:** агент под отдельной учетной записью Telegram + веб-приложение (админка) на VPS.

**Внутри системы:**
- сбор сообщений из подключенных источников (каналы/чаты/обсуждения, где агент состоит);
- фильтрация/ранжирование с использованием правил/эмбеддингов/LLM;
- публикация отобранного в один или несколько каналов-лент;
- автоуправление подписками на каналы (с уведомлениями);
- группы источников (темы) и дайджесты/резюме по группам;
- сбор метрик, аудит действий, дашборд.

**Вне системы:**
- просмотр/транскрибация аудио/видео;
- самостоятельное общение агента в чатах (запрещено);
- обход ограничений Telegram.

## 2. Роли
- **Владелец (User):** управляет политиками, источниками, группами, лентами; дает команды; ставит реакции.
- **Агент (System):** читает, фильтрует, публикует, подписывается/отписывается, делает дайджесты/резюме; ведет логи и метрики.

## 3. Ключевые продуктовые решения (зафиксировано)
- Размещение: **VPS**.
- Автоподписки: **без подтверждения**.
- Обратная связь: **реакции в канале-ленте**.
- Контент: **только текст** (без аудио/видео, без транскрибации).
- Несколько профилей интересов: **несколько каналов-лент/сигналов**, конфигурация настраиваемая.
- Приватность/чаты:
  - агент не вступает в чаты автоматически;
  - вступление только по явной команде владельца;
  - если при вступлении требуется вопрос/верификация — агент пересылает вопрос владельцу и транслирует его ответ;
  - агент не ведет самостоятельных диалогов.

## 4. Термины
- **Источник (Source):** канал/чат/обсуждение.
- **Лента (Feed):** телеграм-канал, куда агент публикует отобранное.
- **Группа источников (Group):** тематическая коллекция источников.
- **Кластер (Cluster):** группа постов об одном событии.
- **Политика (Policy):** набор правил/промптов/порогов для конкретной ленты.
- **Decision Log:** внутренние причины решений (почему показано/не показано/подписался).

## 5. Функциональные требования (FR)

### 5.1 Подключение и сбор контента
**FR-001 (Must)** — Подключение агента к Telegram под отдельной учеткой и чтение новых сообщений из источников, где агент состоит.
- Acceptance: при наличии источника в списке агент видит новые сообщения и ставит их в очередь обработки.

**FR-002 (Must)** — Настраиваемый список источников для чтения (включения/исключения).
- Acceptance: владелец может исключить источник; новые сообщения из него не обрабатываются.

**FR-003 (Must)** — Никакого автоматического вступления в чаты/обсуждения.
- Acceptance: без команды владельца агент не вступает в новые чаты.

### 5.2 Публикация в ленты
**FR-010 (Must)** — Публикация отобранных сообщений в канал-ленту в формате **репоста/форварда оригинала без добавления текста**.
- Acceptance: сообщение в ленте является форвардом; отсутствуют автосгенерированные аннотации/теги/«почему показано».

**FR-011 (Should)** — Поддержка нескольких лент (несколько каналов) с разными политиками.
- Acceptance: владелец может создать/подключить 2+ ленты, привязать к каждой отдельную политику и убедиться, что публикации различаются.

### 5.3 Фильтрация, ранжирование, дедуп
**FR-020 (Must)** — Фильтрация и ранжирование постов по политике конкретной ленты.
- Acceptance: изменение порога/правил политики влияет на состав ленты.

**FR-021 (Must)** — Дедуп по событию: на кластер публикуется **1 лучший** пост.
- Acceptance: при появлении 3 похожих постов (кластер) в ленту попадает ровно 1.

**FR-022 (Should)** — Индикация «есть дубли»: минимальный сигнал (реакция/эмодзи от агента) с числом N.
- Acceptance: если у кластера есть ≥2 источника, на опубликованном посте присутствует индикация с N.

**FR-023 (Must)** — Учет свежести/просрочки по настраиваемым окнам (TTL) в политике.
- Acceptance: посты старше TTL не публикуются (кроме явно разрешенных категорий).

**FR-024 (Must)** — Контентные ограничения: при оценке использовать **только текст**; не пытаться извлекать смысл из аудио/видео.
- Acceptance: система не инициирует транскрибацию и не вызывает обработку медиаконтента.

### 5.4 Управление источниками: авто-подписки/отписки
**FR-030 (Must)** — Автоподписка на новые каналы по решению агента в рамках политики.
- Acceptance: при выполнении критериев агент подписывается на канал без подтверждения.

**FR-031 (Must)** — Уведомление в ленту (или системный канал) о каждой автоподписке с указанием, в какую группу добавлен источник.
- Acceptance: после автоподписки появляется служебное уведомление.

**FR-032 (Should)** — Автоотписка от «лишних» каналов по правилам полезности/давности.
- Acceptance: при систематически низкой полезности агент отписывается и фиксирует это в аудите.

**FR-033 (Must)** — Ручные команды владельца: подписка/отписка/запрет тематик автоподписки.
- Acceptance: команда владельца приводит к немедленному изменению источников и/или политики.

### 5.5 Группы источников и резюме по группам
**FR-040 (Must)** — Сущность «Группа источников» (название + описание принципа группировки).
- Acceptance: владелец может создать группу и увидеть ее в админке/ответе агента.

**FR-041 (Must)** — Команды управления группами: создать/переименовать/изменить описание/удалить.
- Acceptance: команды выполняются, изменения сохраняются.

**FR-042 (Must)** — Команды управления членством: добавить источник в группу/переместить между группами.
- Acceptance: после команды источник числится в новой группе.

**FR-043 (Must)** — Дайджест/резюме по группе за период (день/неделя/произвольный диапазон) по запросу владельца.
- Acceptance: по команде агент публикует/присылает дайджест по группе.

### 5.6 Обратная связь (реакции) и обучение предпочтений
**FR-050 (Must)** — Учет реакций в канале-ленте как сигналов (like/dislike/прочее — настраиваемые соответствия эмодзи→значение).
- Acceptance: реакции записываются в БД как feedback и влияют на статистику источников/тем.

**FR-051 (Should)** — Периодический анализ фидбека для предложения изменений политики (режим «предложить», не применять автоматически).
- Acceptance: агент раз в N дней предлагает корректировки (в сообщении/админке).

### 5.7 Команды в личке и объяснения «по запросу»
**FR-060 (Must)** — Прием команд только из доверенной лички владельца.
- Acceptance: команды из других чатов/пересланных постов не выполняются.

**FR-061 (Must)** — «Почему показано/не показано/почему подписался»: пользователь пересылает пост агенту и получает объяснение.
- Acceptance: агент возвращает объяснение на основе Decision Log.

**FR-062 (Must)** — Вступление в чат по команде владельца.
- Acceptance: агент вступает только после команды.

**FR-063 (Must)** — Трансляция ответов на верификационные вопросы: агент пересылает вопрос владельцу и отправляет в чат **дословный** ответ владельца.
- Acceptance: агент не формулирует ответ сам.

### 5.8 Резюме дискуссий
**FR-070 (Should)** — Резюме длинной дискуссии по запросу владельца (по треду/интервалу сообщений).
- Acceptance: по команде агент формирует резюме установленного формата.

---

## 6. Метрики, сбор статистики и дашборд

### 6.1 Перечень метрик (согласно целям)
**MTR-001** — Доля полезных постов в ленте: лайки/сохранения/дочитывания (минимум: лайки/дизлайки).

**MTR-002** — Снижение времени на чтение Telegram (прокси):
- количество постов в ленте/день;
- количество постов, которые пользователь открыл/переслал/запросил объяснение;
- (опционально) ручная оценка времени/день в админке.

**MTR-003** — Стоимость обработки:
- токены/день по моделям;
- $/день по моделям;
- средняя стоимость на 1 обработанное сообщение/1 опубликованный пост.

**MTR-004** — Уровень повторов:
- % сообщений, отсеянных как дубликаты;
- средний размер кластера;
- число кластеров/день.

**MTR-005** — Время доставки:
- latency от появления сообщения в источнике до публикации в ленте (p50/p95).

**MTR-006** — Качество источников:
- SourceScore;
- доля публикаций/источник;
- лайки/дизлайки на публикации по источнику;
- автоподписки/отписки в период.

### 6.2 Требования к сбору метрик
**FR-080 (Must)** — Система должна собирать перечисленные метрики в БД в разрезах: день/неделя, лента, группа, источник, модель.
- Acceptance: метрики доступны через API/запросы и обновляются автоматически.

**FR-081 (Must)** — Логирование расходов LLM: количество запросов, токены prompt/response, модель, стоимость.
- Acceptance: по каждой операции с LLM есть запись; дневная агрегация сходится с суммой операций.

**FR-082 (Must)** — Аудит действий агента: подписка/отписка/вступление/публикация/изменение политики.
- Acceptance: каждое действие имеет запись с временем, параметрами и инициатором (policy/user).

### 6.3 Дашборд
**FR-083 (Must)** — Веб-дашборд с просмотром метрик:
- графики/таблицы по MTR-001…MTR-006;
- фильтры: период, лента, группа, источник;
- список последних действий агента и ошибок.
- Acceptance: владелец открывает страницу дашборда и видит данные за последние 7/30 дней.

**FR-084 (Should)** — Дашборд бюджета: дневной лимит токенов/стоимости, текущий расход, режим деградации качества.
- Acceptance: при превышении лимита дашборд показывает факт и примененные меры.

---

## 7. Нефункциональные требования (NFR)

**NFR-001 (Must) Производительность** — время доставки (p95) в пределах, задаваемых конфигурацией (целевое значение фиксируется на этапе внедрения).
- Acceptance: измерение latency показывает выполнение целевого p95 на недельной выборке.

**NFR-002 (Must) Надежность** — идемпотентность обработки: повтор события не приводит к повторной публикации.
- Acceptance: при повторной доставке того же сообщения в очередь публикация не дублируется.

**NFR-003 (Must) Безопасность** — хранение сессий/секретов в зашифрованном виде; доступ к админке — по аутентификации.
- Acceptance: секреты не лежат в открытом виде на диске; доступ к админке закрыт.

**NFR-004 (Must) Prompt-injection защита** — агент не выполняет команды из недоверенного контента.
- Acceptance: тестовый набор prompt-injection постов не приводит к выполнению действий.

**NFR-005 (Must) Приватность по чатам** — отсутствие самостоятельного общения в чатах.
- Acceptance: в логах нет сообщений, отправленных агентом в чаты, кроме трансляции ответа владельца на верификационный вопрос.

**NFR-006 (Should) Наблюдаемость** — централизованные логи, ошибки, трассировка pipeline.
- Acceptance: по любому опубликованному посту можно найти цепочку обработки.

---

## 8. Приоритизация (MoSCoW)
**Must:** FR-001,002,003,010,020,021,023,024,030,031,033,040–043,050,060–063,080–083, NFR-002–005.

**Should:** FR-011,022,032,051,070,084, NFR-001,006.

**Could:** дополнительные UX-функции, альтернативные режимы уведомлений, расширенные отчеты.

---

## 9. Минимальный перечень команд (черновик)
*(формат можно менять; важно наличие allowlist)*
- `/feed list|create|delete|set-policy` — управление лентами.
- `/group list|create <name> | set-desc <group> | delete <group>` — управление группами.
- `/group add <group> <source> | move <source> <group>` — членство.
- `/digest <group> <period>` — дайджест по группе.
- `/why` — ответ на пересланный пост: почему показано/не показано/почему подписался.
- `/join <chat_link>` — вступить в чат (только по команде).
- `/verify <answer>` — отправить ответ на последний верификационный вопрос.

---

## 10. Данные (минимальная модель)
- `sources`, `source_groups`, `source_group_membership`
- `feeds`, `feed_policies`
- `messages`, `clusters`, `feed_items`
- `feedback`
- `llm_calls` (tokens/cost)
- `audit_log`
- `metrics_daily` (агрегации)

---

## 11. Критерии готовности MVP
- Одна лента: работает сбор→фильтр→дедуп→форвард.
- Реакции в ленте записываются и видны в дашборде.
- Автоподписки включены, уведомления о подписке с группой приходят.
- Группы: создание/перемещение источников и дайджест по группе за период.
- «Почему показано» по пересланному посту.
- Prompt-injection тесты пройдены.
- Дашборд показывает MTR-001…MTR-005 минимум за 7 дней (или с момента запуска).

