# Техническое задание (черновик)

## 0. Коротко о продукте
Веб‑приложение + Telegram‑«агент» под отдельной учетной записью, который:
1) читает выбранные чаты/каналы пользователя;
2) фильтрует контент через каскад моделей/правил;
3) репостит отобранное в личный «канал‑ленту» пользователя;
4) расширяет/сужает охват источников (подписка/отписка) по качеству;
5) реагирует на команды пользователя (обучение предпочтений, стоп‑источники, дайджесты, резюме дискуссий);
6) контролирует стоимость токенов за счет многоуровневой маршрутизации и кэширования.

> Примечание по рискам: автоматизация действий пользовательского аккаунта Telegram и массовый сбор контента могут быть ограничены правилами/антиспам‑механизмами Telegram. В ТЗ нужно заложить лимиты активности, ручные подтверждения для критичных действий и режим «только рекомендации» (без автоподписок) как fallback.

---

## 1. Цели и ценность
**Основная цель:** дать пользователю персональную новостную ленту из Telegram без подписки на «миллион» каналов, с прозрачным контролем критериев отбора и без зависимости от чужих рекомендательных алгоритмов.

**Ключевые метрики (KPI):**
- Доля «полезных» постов (лайки/сохранения/прочтения) в ленте.
- Снижение времени пользователя на чтение Telegram.
- Стоимость обработки: токены/день и $/день на 1 пользователя.
- Уровень повторов (дубликаты, одно и то же событие).
- Время доставки: задержка от появления поста до попадания в ленту.

---

## 2. Пользовательские сценарии (Use Cases)
### 2.1 Автолента
- Агент читает источники, ранжирует и **публикует в «Канал-Лента» простой репост/форвард исходного сообщения** (без добавления аннотаций/тегов/объяснений в текст сообщения).
- При необходимости пользователь может **переслать пост агенту в личку** и запросить: «почему это показано?» / «почему не отфильтровано?»

### 2.2 Анти-повторы и свежесть
- Группировка постов по одному событию (кластер), показ **1 лучшего**.
- Игнорирование просроченных новостей (настраиваемые окна свежести по темам).

### 2.3 Управление источниками
- Агент выявляет перспективные источники (из репостов/упоминаний/форвардов/пересечений тем) и:
  - **рекомендует подписку** (по умолчанию),
  - **или** подписывается автоматически (опционально, с лимитом/квотой и возможностью авто-отката).
- Агент отписывается от лишних источников с низкой полезностью.

### 2.4 Сигналы об интересных дискуссиях
- Мониторинг чатов: если обсуждают «мою» тему (по профилю интересов) — уведомление в «Канал-Сигналы».

### 2.5 Обратная связь (лайки/команды)
- Пользователь ставит лайк/дизлайк в ленте.
- Пользователь пересылает пост агенту и пишет:
  - «Не интересно / почему»
  - «Больше похожего / почему»
  - «Отписаться от источника»
  - «Подписаться на источник»
  - «Добавь тему X / убери тему Y»

### 2.6 Резюме и дайджесты
- По запросу: резюме длинной дискуссии (тред/цепочка сообщений) или дайджест за день/неделю по выбранным людям/каналам.

### 2.7 Группы источников по темам
- Пользователь ведёт **группы источников** (каналы/люди/чаты) по темам/ролям (например: «Теория», «Технологии», «Друзья», «Новости»).
- Пользователь может запросить: **резюме/дайджест по всей группе** за период.
- Управление группами — через команды в личке агенту:
  - создать группу с названием и описанием принципа;
  - переименовать/изменить описание;
  - добавить канал в группу / переместить между группами;
  - удалить группу (с переносом источников в группу по умолчанию).
- При **автоподписке на новый канал** агент обязан отправить **служебное уведомление** в «Канал-Лента» (или отдельный «Канал-Системные события», если выбран) с указанием: на что подписался и **в какую группу** источник добавлен.

---

## 3. Состав подсистем
### 3.1 Telegram‑коннектор (сбор)
- Подключение к Telegram через MTProto (user‑account) или Bot API (где применимо).
- Получение: новые сообщения/посты, метаданные, реакции, форварды, ссылки.
- Очередь событий (message bus).

### 3.2 Pipeline обработки контента
**Этапы (каскад):**
1) **Лёгкий препроцессинг (без LLM):** язык, длина, тип (новость/мем/реклама), наличие ссылок, первичные спам‑эвристики.
2) **Дешёвая семантика:** эмбеддинги + классификаторы/правила (темы, токсичность/хайп, вероятные фейки по шаблонам, повторяемость).
3) **LLM‑оценка (средняя модель):** «интересность», «новизна», «дубликат события», «какая ценность пользователю», «что с источником».
4) **LLM‑факт‑чек/сложные решения (дорогая модель, редко):** спорные кейсы, настройка профиля, генерация качественных резюме.

### 3.3 Менеджер профиля интересов
- Хранит «профиль пользователя»: темы, запреты, чувствительность к хайпу, окна свежести, приоритеты.
- Генерирует актуальные промпты/политики фильтра.

### 3.4 Менеджер источников
- Скоринг каналов/чатов.
- Лимиты подписок, карантин новых источников, правила отписок.
- Белые/черные списки.
- **Назначение источников в группы** (см. §2.7 и §4.1): хранит текущую группу для каждого канала/чата и историю перемещений.

### 3.5 Публикатор
- Публикует отобранные элементы в Telegram.
- **Требование:** публикация в «Канал-Лента» = репост/форвард исходного сообщения без добавления аннотаций/тегов/объяснений.
- Поддержка нескольких каналов-лент (разные профили интересов).
- Отправка системных уведомлений (например, об автоподписке и назначенной группе) в ленту или в отдельный «Канал-Системные события».

### 3.6 Командный интерфейс
- Парсер команд в личке агенту.
- Поддержка «натуральных» команд + слэш-команд.
- **Безопасный разбор команд:** команды принимаются только из доверенного диалога с владельцем; пересланные сообщения и контент из ленты не должны интерпретироваться как инструкции.
- Команды управления группами и лентами (см. §2.7): создание/редактирование групп, назначение источников, запрос дайджестов/резюме по группе.
- Команды управления конфигурацией лент: создание/удаление канала-ленты, привязка политики, изменение лимитов.

### 3.7 UI веб‑приложения (админка)
- Настройка тем/источников/квот.
- Просмотр статистики и расходов.
- Ручное подтверждение автоподписок (если режим «approve»).

---

## 4. Данные и хранилища
### 4.1 Основные сущности
- **Message**: id, chat_id, author_id, timestamp, text, media_meta, links, forward_from, views.
- **Source** (канал/чат): id, title, type, join_date, activity stats.
- **SourceGroup**: id, name, description, rules (текст принципа группировки), created_at, updated_at.
- **SourceGroupMembership**: source_id, group_id, assigned_by (user/agent), assigned_at.
- **FeedItem**: message_id, score, cluster_id, published_at, duplicate_count.
- **Cluster/Event**: embedding centroid, representative message, time window.
- **Feedback**: like/dislike, reason, time, linked message/feed item.
- **Policy/Prompt**: версия правил, изменения, автор (user/agent), дата.

### 4.2 Хранилища
- Postgres (метаданные, профили, источники, фидбек).
- Object storage (медиа‑превью при необходимости).
- Vector DB (Faiss/pgvector) для эмбеддингов и кластеризации.
- Cache (Redis) для дедупа, rate limits, кэша LLM‑ответов.

### 4.3 Политика хранения
- Срок хранения сырых сообщений (настройка, напр. 30–90 дней).
- Хэширование/шифрование чувствительных данных.

---

## 5. Алгоритмы и правила (MVP → v2)
### 5.1 Скоринг поста
Итоговый **FeedScore =** f(релевантность темам, новизна/неповтор, качество источника, свежесть, «анти-хайп», доверие).

**Обязательные фильтры (MVP):**
- Жесткие стоп-слова/стоп-темы.
- Ограничение повторов: 1 пост на кластер/событие в N часов.
- Ограничение «мусора»: мемы/реклама/розыгрыши по правилам.
- **Мультимедиа:** для аудио/видео не выполнять распознавание/транскрибацию; при оценке использовать только текст поста и текстовые описания/подписи.

### 5.2 Дедуп и «одно событие»
- Эмбеддинги + cosine similarity.
- Кластеризация по скользящему окну (напр. 48 часов).
- Доп. признаки: одинаковые ссылки, одинаковые сущности (NER), совпадения заголовков.
- **Политика показа:** по каждому кластеру публикуется **только 1 лучший** пост.
- **Индикатор наличия дублей:** к посту может добавляться минимальная реакция/метка (например, выбранная эмодзи-реакция от агента) с числом N, что «есть ещё N похожих в других источниках». Детали (какие именно источники) выдаются только по запросу пользователя в личке.

### 5.3 Просроченные новости
- По темам разные TTL: например, «срочные новости» 24–48ч, «теория/эссе» без TTL.
- LLM‑оценка «устарело/не устарело» только если эвристики не уверены.

### 5.4 Оценка источников
**SourceScore** на основе:
- Доля постов, попавших в ленту.
- Доля лайков/дизлайков по этому источнику.
- Уникальность (не повторяет другие источники).
- Частота «хайпа/фейков».

**Подписка (v1):** рекомендовать топ‑K источников в неделю.
**Подписка (v2):** автоподписка в «карантин» + лимит 1–3/день.

**Отписка:**
- Если за T дней нет постов выше порога или много дизлайков.
- Автоотписка только при высокой уверенности + уведомление пользователю.

### 5.5 Сигналы о дискуссиях
- Детект темы в чате по эмбеддингам + порог «температуры обсуждения» (число сообщений/мин).
- Сигнал: тема, участники (без раскрытия, если приватно), ссылка на фрагмент.

### 5.6 Резюме дискуссий
- Сбор контекста по треду/периоду.
- Сжатие: map‑reduce суммаризация.
- Формат: тезисы, аргументы, вопросы, решения, открытые хвосты.

---

## 6. Промпты и управление политиками
### 6.1 Версионирование
- Любая правка промпта → новая версия (PromptVersion).
- Возможность отката.

### 6.2 Объяснимость «по запросу»
- В тексте сообщений в ленте **не выводить** объяснения.
- Система должна хранить внутренний **Decision Log** для каждого FeedItem (ключевые факторы, сработавшие правила, ссылки на кластер/дубликаты, версия политики), чтобы по запросу пользователя в личке можно было ответить: «почему показано» / «почему не показано» / «почему подписался на источник».
- Для приватности/экономии допускается хранить Decision Log в сжатом виде и с TTL.

### 6.3 Автоуточнение профиля
- Периодически (напр. раз в неделю) агент предлагает изменения в профиле на основе лайков/команд.
- По умолчанию — режим «предложить», а не «применить».

---

## 7. Экономия токенов и маршрутизация моделей
### 7.1 Стратегия каскада
1) **0‑LLM фильтры**: регулярки, URL‑шаблоны, длина, язык, повтор по хэшам.
2) **Embeddings**: тема/дедуп/кластеры.
3) **Small LLM**: быстрые решения (интересно/неинтересно, краткая аннотация).
4) **Large LLM**: редкие сложные задачи (факт‑чек, конфликтные случаи, обучение профиля, длинные резюме).

### 7.2 Кэширование
- Кэш по `(message_id, policy_version)`.
- Кэш кластеризации по окнам.

### 7.3 Бюджеты
- `daily_token_budget` и `daily_cost_budget`.
- Деградация качества при превышении: меньше резюме, выше порог интересности, отключение дорогих проверок.

---

## 8. Нефункциональные требования
### 8.1 Производительность
- Обработка новых сообщений в течение X минут (MVP: 5 мин).
- Стабильная работа при Y сообщений/день (задается).

### 8.2 Надежность
- Отказоустойчивая очередь.
- Повторная обработка (idempotency).
- Логи и трассировка решений (Decision Log).

### 8.3 Безопасность и приватность
- Шифрование токенов/сессий Telegram.
- Роли доступа (только владелец).
- Размещение: **VPS** (самостоятельно администрируемый сервер).
- Возможность исключать отдельные источники/чаты.

### 8.4 Соответствие и ограничения
- Rate limits на подписки/отписки/публикации/чтение.
- «Безопасный режим» (нет автоподписок, только рекомендации).

### 8.5 Защита от prompt-injection и несанкционированных действий
- Любой входящий контент (посты, сообщения, ссылки) считать **недоверенным**.
- Агент обязан **игнорировать инструкции из контента**, которые пытаются изменить правила работы агента, запросить секреты, заставить подписаться/отписаться/написать куда-то и т.п.
- Действия (подписка/отписка/вступление/публикация/ответ в чат) выполнять **только** если они инициированы политикой агента и/или явной командой пользователя.
- Рискованные операции:
  - **вступление в чат/обсуждение** — только по явной команде пользователя;
  - **ответы в чатах** — только в режиме «трансляции» ответа пользователя на верификационный вопрос.
- Командный интерфейс — allowlist:
  - принимать команды только из доверенной лички владельца;
  - предпочтительно использовать слэш-команды/устойчивые шаблоны;
  - не интерпретировать пересланные посты/цитаты как команды.
- Логировать рискованные операции (инициатор, контекст, время) и обеспечивать быстрый откат (например, авто-отписка/выход из чата).

## 9. Интеграционные требования (Telegram)
- Поддержка:
  - чтение каналов/чатов,
  - публикация в канал‑ленту,
  - обработка пересланных сообщений в личке,
  - чтение реакций/лайков.
- Ограничения по типам: закрытые каналы, приватные группы, мегагруппы.

---

## 10. Логи, мониторинг, аналитика
- Дашборд:
  - сообщения вход/выход,
  - топ‑темы,
  - топ‑источники,
  - лайки/дизлайки,
  - расходы по моделям.
- Аудит действий агента: подписка/отписка/публикация/изменение политики.

---

## 11. MVP (минимальный релиз)
1) Сбор сообщений из списка источников.
2) Дедуп + простая LLM‑оценка интересности.
3) Публикация в канал‑ленту с источником и краткой аннотацией.
4) Базовые команды: стоп‑тема, стоп‑источник, «больше/меньше такого», запрос резюме.
5) Логи решений + лимиты токенов.

**v1+:** рекомендации новых источников, сигналы о дискуссиях.

**v2:** автоподписка/автоотписка, автоуточнение профиля, продвинутый дайджест.

---

## 12. Принятые продуктовые решения (из ответов пользователя)
- **Среда исполнения агента:** виртуальный сервер (VPS).
- **Автоподписки:** подтверждение не требуется; пользователь при необходимости отписывается вручную и/или корректирует политику (чтобы не подписываться на определённые тематики сверх уже заданных).
- **Лайки/дизлайки:** реакции в Telegram в канале-ленте.
- **Типы контента:** ориентируемся **только на текст** (текст поста и текстовые описания/подписи). Аудио/видео **не слушать/не смотреть**, не делать транскрибацию.
- **Несколько профилей интересов:** реализуются как несколько каналов-лент (и/или каналов-сигналов) с разными политиками; конфигурация набора каналов — настраиваемая.
- **Политика приватности по чатам:**
  - агент **не подключается к чатам/обсуждениям автоматически**;
  - подключение/вступление — только по прямой просьбе пользователя;
  - если при вступлении требуется «проверка-вопрос»/капча/верификация, агент пересылает вопрос пользователю и **дословно транслирует ответ** в чат;
  - агент **не ведёт самостоятельные диалоги** в чатах.
- **Защита от prompt-injection:** требуется отдельный контур контроля (см. §8.5).

## 13. Формат публикации в ленту (требование)
- **Публикация = репост/форвард оригинального сообщения** в «Канал-Лента».
- Дополнительный текст (аннотации, теги, «почему показано») **не добавлять**.
- Допускается добавлять минимальный *машиночитаемый* сигнал (например, реакцию/эмодзи) для индикации наличия дублей в других источниках.
- Любые объяснения и детали (причины отбора, список дублирующих источников, обоснование подписки/отписки) выдаются **только по запросу** пользователя в личке агенту.

